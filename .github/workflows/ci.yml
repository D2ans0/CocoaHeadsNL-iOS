name: CI

on:
  # Trigger the workflow on push or pull request,
  # but only for the master branch
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

  workflow_dispatch:
    inputs:
      destination:
        type: choice
        description: Phone model to test
        default: iPhone 8
        options:
        - iPhone 8
        - iPhone 8 Plus
        - iPhone 11
        - iPhone 11 Pro
        - iPhone 11 Pro Max
        - iPhone 12
        - iPhone 12 Pro
        - iPhone 12 Pro Max
        - iPhone 12 Mini
        - iPhone 13
        - iPhone 13 Pro
        - iPhone 13 Pro Max
        - iPhone 13 mini
        - iPhone SE (2nd generation)

jobs:
  Test:
    runs-on: macOS-latest
    steps:
    
#     - name: Setup environment variables
#       run: |
#         export PROJECT_PATH=$(find ./ -name "*.xcodeproj");
#         export PROJECT_NAME=$(basename "${PROJECT_PATH%.*}"); \
#         export SCHEME_PATH=$(find $PROJECT_PATH -name "$PROJECT_NAME.xcscheme")

    - uses: actions/checkout@v1
        
    - name: List available Xcode versions
      run: ls /Applications | grep Xcode
#     - name: Select Xcode
#       run: sudo xcode-select -switch /Applications/Xcode_12.5.app && /usr/bin/xcodebuild -version
    - name: Run unit tests
      run: |
        # hacky way to give a default value to an input, blame GitHub, lol
        DESTINATION=${{ github.event.inputs.message }}
        DESTINATION=${DESTINATION:-"iPhone 8"}
        
        # gets project path, name and path to all schemes in the project
        PROJECT_PATH=$(find ./ -name "*.xcodeproj"); \
        PROJECT_NAME=$(basename "${PROJECT_PATH%.*}"); \
        SCHEME_PATH=$(find $PROJECT_PATH -name "$PROJECT_NAME.xcscheme"); \
        ls -l; echo $PROJECT_NAME; echo $PROJECT_PATH; \
        
        xcodebuild test \
        -scheme $PROJECT_NAME \
        -project $PROJECT_PATH \
        -destination "platform=iOS Simulator,name=${DESTINATION},OS=15.2"\
        | xcpretty && exit ${PIPESTATUS[0]}

        
